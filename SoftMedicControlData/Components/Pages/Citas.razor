@page "/Citas" 
@using Microsoft.AspNetCore.Components.Forms

<PageTitle>Gestión de Citas</PageTitle>

@attribute [StreamRendering]
@rendermode InteractiveServer

@inject MedicoServices medicoService
@inject CitaServices citaService
@using SoftMedicControlData.Services

<style>

    :root {
        --azul-suave: #6C8EBF;
        --verde-agua: #7FCDCD;
        --gris-claro: #F0F4F8;
    }

    body {
        background-color: var(--gris-claro);
    }

    .container {
        padding: 30px;
        max-width: 1400px;
        margin: auto;
    }

    h2 {
        color: var(--azul-suave);
        margin-bottom: 20px;
    }

    .form-section, .list-section {
        background-color: white;
        border-radius: 12px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        padding: 20px;
        margin-bottom: 30px;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }

    table, th, td {
        border: 1px solid #ddd;
    }

    th, td {
        padding: 10px;
        text-align: left;
    }

    .section {
        background-color: white;
        border-radius: 12px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        padding: 20px;
        margin-bottom: 30px;
    }

    .section_buttons {
        display: flex;
        justify-content: center; 
        gap: 10px; 
        margin: 15px 0; 
    }

        .section_buttons .btn {
            min-width: 120px; 
        }

    .filter-group {
        display: flex;
        gap: 1rem; /* espacio entre columnas */
        justify-content: space-between;
    }


    .form-group {
        margin-bottom: 20px;
    }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }

            .form-group input:focus,
            .form-group textarea:focus,
            .form-group select:focus {
                border-color: var(--verde-agua);
                outline: none;
            }

    .btn {
        background-color: var(--verde-agua);
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
    }

    .btn:hover {
        background-color: #66baba;
    }

    .popup {
        position: fixed;
        top: 30%;
        left: 40%;
        background-color: white;
        border: 2px solid var(--azul-suave);
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        z-index: 1000;
    }

    .ventana-flotante {
        background: white;
        border-radius: 8px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
    }

    .ventana-header {
        background: #2c3e50;
        color: white;
        padding: 10px 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .ventana-controles {
        display: flex;
        gap: 10px;
    }

    .btn-ventana {
        background: transparent;
        border: none;
        color: white;
        cursor: pointer;
        padding: 3px 8px;
        border-radius: 3px;
    }

    .ventana-body {
        padding: 20px;
    }

    .ventana-footer {
        padding: 15px;
        background: #f8f9fa;
        border-top: 1px solid #eee;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }

    .overlay {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background-color: rgba(0,0,0,0.5);
        z-index: 999;
    }
</style>

<div class="header">
    <img src="/images/logo-softmedic.png" alt="Logo SoftMedic" />
    <h1>Gestión de Citas Médicas</h1>
</div>

<div class="container">

    <div class="section_buttons">
        <button class="btn btn-sm btn-primary" @onclick="() => AbrirVentanaNuevaCita()" style="background-color: deepskyblue">
            <i class="fa-solid fa-plus"> NUEVA</i>
        </button>

        <button class="btn btn-sm btn-primary" @onclick="() => AbrirVentanaConsultarCita()" style="background-color: deepskyblue">
            <i class="fa-solid fa-magnifying-glass"> CONSULTAR</i>
        </button>
    </div>

    @if (ventanaNuevaCitaVisible == true)
    {
        <!-- Formulario de cita -->
        <div class="section">
            <h2>Programar Cita</h2>
            <EditForm Model="@cita" OnValidSubmit="GuardarCita">
                <DataAnnotationsValidator />
                <ValidationSummary />

                <div class="form-group">
                    <label>ID Paciente</label>
                    <InputNumber @bind-Value="cita.CedulaPaciente" />
                </div>

                <div class="form-group">
                    <label>Fecha</label>
                    <InputDate @bind-Value="FechaSeleccionada" />
                </div>

                <div class="form-group">
                    <label>Hora</label>
                    <InputTime @bind-Value="HoraSeleccionada" />
                </div>

                <div class="form-group">
                    <label>Motivo</label>
                    <InputTextArea @bind-Value="cita.Motivo" />
                </div> 

                <div class="form-group">
                    <label>Especialidad</label>
                    <InputSelect class="form-control" @bind-Value="IdEspecialidadSeleccionada" >
                        <option disabled selected value="0">-- Seleccione --</option>
                        @foreach (var especialidad in ListaEspecialidades)
                        {
                            <option value="@especialidad.IdEspecialidad">@especialidad.NombreEspecialidad</option>
                        }
                    </InputSelect>
                </div>

                <div class="form-group">
                    <label>Médico</label>
                    <InputSelect class="form-control" @bind-Value="cita.IdMedico">
                        <option disabled selected value="0">-- Seleccione --</option>
                        @if(ListaMedicosDisponinles.Count > 0)
                        {
                            @foreach (var medico in ListaMedicosDisponinles)
                            {
                                <option value="@medico.IdMedico">@medico.Nombre @medico.Apellido</option>
                            }
                        }
                    </InputSelect>
                </div>

                <div class="form-group">
                    <label>Servicio</label>
                    <InputSelect class="form-control" @bind-Value="cita.IdServicio">
                    <option disabled selected value="0">-- Seleccione --</option>
                        @foreach (var serivio in ListaServiciosMedicos)
                        {
                            <option value="@serivio.IdServicio">@serivio.NombreServicio</option>
                        }
                    </InputSelect>
                </div>

                <div class="form-group">
                    <label>Estado</label>
                    <InputSelect class="form-control" @bind-Value="cita.Estado">
                        <option disabled selected value="">-- Seleccione --</option>
                        <option value="Cancelada">Cancelada</option>
                        <option value="Agendada">Agendada</option>
                        <option value="Tomada">Tomada</option>
                    </InputSelect>
                </div>

                <button type="submit" class="btn">Guardar Cita</button>
            </EditForm>
        </div>
    }

    @if(ventanaConsultaCitaVisible == true)
    {
        <div class="section">
            <h2>Citas registradas</h2>

            <div class="filter-group">

                <div class="form-group">
                    <label>Por Id paciente</label>
                    <InputNumber placeholder="Buscar por documento paciente" @bind-Value="filtroDocumentoPaciente" />
                </div>
                <div class="form-group">
                    <label>Por fecha</label>
                    <InputDate placeholder="Buscar por fecha" @bind-Value="filtroFecha" />
                </div>
                <div class="form-group">
                    <label>Por Id médico</label>
                    <InputNumber placeholder="Buscar por documento Médico" @bind-Value="filtroDocumentoMedico" />
                </div>

            </div>

            <table>
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Hora</th>
                        <th>Motivo</th>
                        <th>Estado</th>
                        <th>Cedula Paciente</th>
                        <th>Nombre Paciente</th>
                        <th>Cedula Medico</th>
                        <th>Nombre Medico</th>
                        <th>Servicio</th>

                    </tr>
                </thead>
                <tbody>
                    @foreach (var p in listaCitas.Where(p =>
                                    p.CedulaPaciente.Equals(filtroDocumentoPaciente) ||
                                    p.IdMedico.Equals(filtroDocumentoMedico) ||
                                    p.Fecha.Equals(filtroFecha) 
                    ))
                    {
                        <tr>
                            <td>@p.Fecha</td>
                            <td>@p.Hora</td>
                            <td>@p.Motivo</td>
                            <td>@p.Estado</td>
                            <td>@p.CedulaPaciente</td>
                            <td>@p.NombrePaciente</td>
                            <td>@p.IdMedico</td>
                            <td>@p.NombreMedico</td>
                            <td>@p.NombreServicio</td>
                            <td>
                                <button class="btn btn-sm btn-primary" @onclick="() => AbrirVentanaFlotante(p)" style="background-color: lightseagreen">
                                    <i class="fa fa-edit"></i>
                                </button>
                            </td>

                            <td>
                                <button class="btn btn-sm btn-primary" @onclick="() => EliminarCita(p)" style="background-color: lightcoral">
                                    <i class="fa fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>

            @if (ventanaEditVisible && @citaEditada != null)
            {
                <div class="modal-overlay">

                    <div class="ventana-flotante">
                        <div class="ventana-header">
                            <span>Editando Cita </span>
                            <div class="ventana-controles">
                                <button @onclick="() => CerrarVentanaEdit()" class="btn-ventana">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>

                        <div class="ventana-body">
                            <EditForm Model="@citaEditada">

                                <div class="form-group">
                                    <label>ID Paciente</label>
                                    <InputNumber @bind-Value="citaEditada.CedulaPaciente" />
                                </div>

                                <div class="form-group">
                                    <label>Fecha</label>
                                    <InputDate @bind-Value="FechaSeleccionada" />
                                </div>

                                <div class="form-group">
                                    <label>Hora</label>
                                    <InputTime @bind-Value="HoraSeleccionada" />
                                </div>

                                <div class="form-group">
                                    <label>Motivo</label>
                                    <InputTextArea @bind-Value="citaEditada.Motivo" />
                                </div>

                                <div class="form-group">
                                    <label>Especialidad</label>
                                    <InputSelect class="form-control" @bind-Value="IdEspecialidadSeleccionada">
                                        <option disabled selected value="0">-- Seleccione --</option>
                                        @foreach (var especialidad in ListaEspecialidades)
                                        {
                                            <option value="@especialidad.IdEspecialidad">@especialidad.NombreEspecialidad</option>
                                        }
                                    </InputSelect>
                                </div>

                                <div class="form-group">
                                    <label>Médico</label>
                                    <InputSelect class="form-control" @bind-Value="citaEditada.IdMedico">
                                        <option disabled selected value="0">-- Seleccione --</option>
                                        @if (ListaMedicosDisponinles.Count > 0)
                                        {
                                            @foreach (var medico in ListaMedicosDisponinles)
                                            {
                                                <option value="@medico.IdMedico">@medico.Nombre @medico.Apellido</option>
                                            }
                                        }
                                    </InputSelect>
                                </div>

                                <div class="form-group">
                                    <label>Servicio</label>
                                    <InputSelect class="form-control" @bind-Value="citaEditada.IdServicio">
                                        <option disabled selected value="0">-- Seleccione --</option>
                                        @foreach (var serivio in ListaServiciosMedicos)
                                        {
                                            <option value="@serivio.IdServicio">@serivio.NombreServicio</option>
                                        }
                                    </InputSelect>
                                </div>

                                <div class="form-group">
                                    <label>Estado</label>
                                    <InputSelect class="form-control" @bind-Value="citaEditada.Estado">
                                        <option disabled selected value="">-- Seleccione --</option>
                                        <option value="Cancelada">Cancelada</option>
                                        <option value="Agendada">Agendada</option>
                                        <option value="Tomada">Tomada</option>
                                    </InputSelect>
                                </div>

                                <div class="ventana-footer">
                                    <button @onclick="() => GuardarCambios()" class="btn btn-success" style="background-color: lightseagreen">
                                        <i class="fas fa-save"></i> Guardar
                                    </button>

                                    <button @onclick="() => CerrarVentanaEdit()" class="btn btn-secondary" style="background-color: lightcoral">
                                        <i class="fa-solid fa-xmark"></i> Cancelar
                                    </button>
                                </div>
                            </EditForm>
                        </div>
                    </div>
                </div>
            }


        </div>
    }
        

@if (mostrarPopup)
{
    <div class="overlay" @onclick="()=>mostrarPopup = false"></div>
    <div class="popup">
            @if (citaRegistradaOK)
            {
                <p>✅ ¡Cita registrada con éxito!</p>
            }
            @if (citaEditadaOK)
            {
                <p>✅ ¡Cita editada con éxito!</p>
            }
        <button class="btn" @onclick="()=>mostrarPopup = false">Cerrar</button>
    </div>
} 

</div>